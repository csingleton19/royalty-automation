from flask import Flask, jsonify, request
from services.data_extraction.pdf_extractor import extract_pdf_content
from services.data_extraction.data_cleaner import clean_extracted_text
from services.information_extraction.extractor import (
    extract_structured_data_with_llm,
    extract_unstructured_data_with_llm,
    extract_and_save_authors_data,
    save_data_as_json,
)
from config.config import BASE_DIR
import os
import pickle

app = Flask(__name__)

# Load cleaned data from centralized storage
def load_cleaned_data():
    pickle_path = os.path.join(BASE_DIR, "storage/pickles", "cleaned_data.pkl")
    try:
        with open(pickle_path, "rb") as file:
            cleaned_data = pickle.load(file)
        return cleaned_data
    except FileNotFoundError:
        return None


@app.route("/api/extract-pdf", methods=["POST"])
def extract_pdf():
    """
    Endpoint to extract text content from a PDF.
    """
    if "file" not in request.files:
        return jsonify({"error": "No file provided"}), 400

    file = request.files["file"]
    if not file.filename.endswith(".pdf"):
        return jsonify({"error": "Only PDF files are supported"}), 400

    # Save uploaded file to storage
    pdf_storage_path = os.path.join(BASE_DIR, "storage/pdfs", file.filename)
    file.save(pdf_storage_path)

    # Extract text content from PDF
    try:
        extracted_text = extract_pdf_content(pdf_storage_path)
        return jsonify({"status": "success", "extracted_text": extracted_text}), 200
    except Exception as e:
        return jsonify({"error": f"Failed to extract PDF content: {str(e)}"}), 500


@app.route("/api/clean-text", methods=["POST"])
def clean_text():
    """
    Endpoint to clean extracted text.
    """
    data = request.get_json()
    if not data or "text" not in data:
        return jsonify({"error": "Text to clean not provided"}), 400

    raw_text = data["text"]
    cleaned_text = clean_extracted_text(raw_text)
    return jsonify({"status": "success", "cleaned_text": cleaned_text}), 200


@app.route("/api/extract-structured-data", methods=["POST"])
def extract_structured_data():
    """
    Endpoint to extract structured data using LLM.
    """
    data = load_cleaned_data()
    if data is None:
        return jsonify({"error": "Cleaned data not found"}), 404

    try:
        structured_data = extract_structured_data_with_llm(data)
        return jsonify({"status": "success", "structured_data": structured_data}), 200
    except Exception as e:
        return jsonify({"error": f"Failed to extract structured data: {str(e)}"}), 500


@app.route("/api/extract-unstructured-data", methods=["POST"])
def extract_unstructured_data():
    """
    Endpoint to extract unstructured data using LLM.
    """
    data = load_cleaned_data()
    if data is None:
        return jsonify({"error": "Cleaned data not found"}), 404

    try:
        unstructured_data = extract_unstructured_data_with_llm(data)
        return jsonify({"status": "success", "unstructured_data": unstructured_data}), 200
    except Exception as e:
        return jsonify({"error": f"Failed to extract unstructured data: {str(e)}"}), 500


@app.route("/api/save-authors-data", methods=["POST"])
def save_authors_data():
    """
    Endpoint to extract and save authors' data from structured data.
    """
    data = load_cleaned_data()
    if data is None:
        return jsonify({"error": "Cleaned data not found"}), 404

    try:
        structured_data = extract_structured_data_with_llm(data)
        extract_and_save_authors_data(structured_data)
        return jsonify({"status": "success", "message": "Authors' data saved"}), 200
    except Exception as e:
        return jsonify({"error": f"Failed to save authors' data: {str(e)}"}), 500


@app.route("/api/save-unstructured-data", methods=["POST"])
def save_unstructured_data():
    """
    Endpoint to save unstructured data as JSON.
    """
    data = load_cleaned_data()
    if data is None:
        return jsonify({"error": "Cleaned data not found"}), 404

    try:
        unstructured_data = extract_unstructured_data_with_llm(data)
        save_data_as_json(unstructured_data, "unstructured_data")
        return jsonify({"status": "success", "message": "Unstructured data saved"}), 200
    except Exception as e:
        return jsonify({"error": f"Failed to save unstructured data: {str(e)}"}), 500


if __name__ == "__main__":
    app.run(debug=True)
